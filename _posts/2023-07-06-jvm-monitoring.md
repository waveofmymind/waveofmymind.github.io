---
title: "Heap 영역 모니터링"
date: 2023-06-01 10:12:00 +0900
aliases: 
tags: [Heap,Heapdump,Java,JVM]
categories: [Java]
---

굿잡 프로젝트에서는 매일 4시경 스프링 배치를 통해 외부 API 호출 및 웹 크롤링을 통해 채용 공고 데이터를 가져오는 작업이 수행됩니다.

크롬 웹 드라이버를 통해 웹 서버를 크롤링하고, 외부 API를 호출하는 것이 비동기로 수행됨에 따라 배치가 수행되면서 모놀리식 프로젝트에서 하나의 프로세스 자체가 요구하는 메모리량이 크게 증가하였습니다.

또한 배치 서비스가 수행될 때 발생하는 부하로 본 프로젝트가 느려지는 영향이 있었고, 이를 해결하기 위해서 
배치 프로젝트를 본 프로젝트와 분리하여 실행시키기로 하였습니다.

스케줄링 작업을 통해 얻어온 데이터를 카프카를 사용해서 메시지 큐로 보내고, 본 프로젝트에서 이를 수신해서 가공한 뒤 RDB에 저장하게 됩니다.

그리고 배치 프로젝트를 쿠버네티스 디플로이먼트를 통해 파드로 배포하게 되었고, 제 쿠버네티스 클러스터에는 본 서비스와 배치 서비스 두 개의 프로젝트가 실행되었습니다.

그리고 그 중심에는 카프카를 두어 비동기 처리를 하도록 구성했습니다.

그러나 배치 프로젝트의 크롤링이 수행되면서 프로젝트 서버 자체가 메모리 부족으로 죽는 경우가 계속 발생했습니다.

디플로이먼트에 의해 다시 실행되는 것은 문제 없었지만, 문제는 랜덤하게 죽는 배치 서버에 의해 데이터가 일관적으로 들어오지 못했습니다.

이를 해결하기 위해 배치 프로젝트의 JVM 메모리 영역 중, 힙 영역을 모니터링 하고자 하였습니다.

## VisualVM & VisualGC

위에서 발생했던 문제를 모니터링 하기 위해 VisualVM을 사용했습니다.

OracleJDK에서 제공하는 GUI 모니터링 툴로, VisualVM을 구글에 검색해서 나오는 홈페이지에서 다운을 받아줍니다.

그리고 저희는 힙 영역을 주로 모니터링 할 것이기 때문에 맥 기준 상단에 Tools -> Plugin에서 VisualGC 플러그인을 다운 받아줍니다.


이는 위처럼 GC 영역들에 대해서 보기좋게 확인할 수 있습니다.




