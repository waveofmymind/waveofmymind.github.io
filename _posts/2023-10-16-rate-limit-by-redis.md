---

title: "더블 클릭 요청 방지하기 - RateLimiter"
date: 2023-10-26 09:29:00 +0900
aliases: 
tags: [Redis,Spring]
categories: [Redis]

---

레주마블 프로젝트를 개발하면서 발생한 문제와 트러블 슈팅을 공유하고자합니다.

## **문제 상황**

레주마블 프로젝트의 핵심 서비스인 면접 예상 질문 생성은 다음과 같이, 사용자 이력서와 각종 정보를 입력한 후, 결과 생성 버튼으로 백엔드 서버에 요청하게 됩니다.

![problem](/assets/img/2023-10-26-rate-limit-by-redis/process.webp)

그러나 이때, 짧은 순간에 더블 클릭시 요청이 두번 가는 문제가 발생했습니다.

사용자는 한 요청만 응답받게 되지만, 실제 서버에는 요청이 두번 나가기 때문에 DB에도 같은 내용이 두 번 저장됩니다. 이는 마이페이지에서 사용자가 같은 데이터를 중복으로 볼 수 있기 때문에 사용성을 저하하고, 서버에서의 중복 데이터를 삭제할 필요가 생깁니다.

또한 OpenAi의 API를 사용량이 일정 limit을 초과하면 유료로 과금이 되기 때문에, 중복 요청에 대한 서버쪽의 추가적인 과금을 막는 것은 중요합니다.

그래서 처리율 제한 장치를 도입하여 사용자가 더블 클릭해서 같은 요청을 두 번 보내는 것을 막아보고자 했습니다.

## **처리율 제한 장치란?**

처리율 제한 장치는 트래픽의 처리율을 제한하기 위해 사용됩니다.

API 요청 횟수가 미리 정의된 임계치(ThreadHold)를 넘어서면 추가로 도달한 요청은 처리가 중단(Block)됩니다.

### **처리율 제한 장치의 위치**

이때 클라이언트 서버에서 요청을 막으면 되지 않는가 라는 생각을 할 수 있지만,

위변조가 쉽기 때문에 안정적으로 처리율을 제한할 수 없다는 문제가 있습니다.

그리고 마이크로서비스 환경에서는 미들웨이(예를 들어 게이트 웨이)에 처리율 제한 장치를 두어 요청을 막기도 합니다.

### **어떤 알고리즘을 사용해야 하는가**

처리율 제한 장치를 구현하기 위한 알고리즘으로는 다음과 같습니다.

- 토큰 버킷
- 누출 버킷
- 고정 윈도 카운터
- 이동 윈도 로그
- 이동 윈도 카운터

**토큰 버킷**

간단하고 보편적으로 사용되는 알고리즘입니다.

1. 컨테이너에 지정된 개수의 토큰이 주기적으로 채워집니다.
2. 하나의 요청은 하나의 토큰을 처리하며, 토큰이 없는 경우 해당 요청은 버려집니다.

컨테이너는 구분하려는 요청마다 개수가 달라집니다.

예를 들어 IP마다 컨테이너가 필요할 수도, 로직별로 컨테이너를 둘 수도 있습니다.

구현이 간단하지만 컨테이너가 토큰을 담을 수 있는 크기와 토큰을 어떤 주기마다 채울지를 튜닝해야합니다.

**누출 버킷**

큐로 구현하며, 큐가 가득 차 있을 경우 요청은 버려집니다.

큐의 크기만을 조정하기 때문에 메모리 사용량이 효율적이지만, 많은 트래픽이 올 경우 오래된 요청만 쌓이고 최신 요청은 다 버려질 수 있습니다.

**고정 윈도 카운터**

시간을 기준으로 윈도우를 만들고, 윈도우마다 카운터를 붙입니다.

요청마다 카운터의 값을 증가시키고, 임계치에 도달하면 시간이 지날때까지 버려집니다.

이는 윈도우의 경계 부근에서 요청이 임계치보다 많이 처리될 수 있는 문제가 있습니다.

**이동 윈도 로깅**

고정 윈도 카운터의 단점을 해결하기 위해서, 타임 스탬프를 기록하며 **들어온 요청 시간 - 정해진 시간** 내의 요청 개수를 체크해서 요청 처리 여부를 결정합니다.

**이동 윈도 카운터**

상기 두 알고리즘을 결합한 것으로, 직전 요청 수와 현재 1분간의 요청 수, 겹치는 비율을 통해 남은 요청의 비율을 계산해서 요청 처리 여부를 결정합니다.

저희 프로젝트는 분당 요청 횟수를 고려할만큼 많은 트래픽이 있지 않기 때문에 고정 윈도 카운터를 사용하고자 합니다.




## **레퍼런스**

- [가상 면접 사례로 배우는 대규모 시스템 설계 기초](https://www.yes24.com/Product/Goods/102819435)




