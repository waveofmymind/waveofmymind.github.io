---

title: "스프링 이벤트로 우아한 로그 저장하기"
date: 2023-12-31 09:29:00 +0900
aliases: 
tags: [Kotlin,Spring Event,Spring]
categories: [Spring]

---

레주마블 프로젝트에서는 면접 예상 질문 생성시 성공/실패 모두 로그로 저장하고 있습니다.

프롬프트를 기반으로 ChatCompletion이 동작하기 때문에, 요청 내용이 예상과 다를 경우 Chat-GPT가 프롬프트대로 응답 형식을 내려주지 않을 때가 있습니다.

예를 들어 이력서 내용이 아닌, 'Hello?'와 같은 인삿말을 넘겼을 때 JSON 데이터가 아닌 Chat-GPT가 역으로 안부를 되묻는 경우도 있기 때문입니다.

그래서 사용자 요청 내용을 성공/실패로 나누어 로그 테이블로 저장하고 있는 것입니다.

그러나 문제는 프로젝트에서 한번에 여러 요청을 보낼 수 있도록 기능을 확장했을 때 발생했습니다.

두 항목에 대한 이력서 내용에 대해 예상 질문을 요청했을 때, 코루틴을 활용해서 병렬 처리로 Chat Completion을 수행하고, 모든 응답을 취합해서 결과를 내려주게 되는데요.

이는 두가지 문제점이 발생할 수 있습니다.

1. 두 요청 다 실패할 경우, 실패했다는 로그가 DB에 저장되어야하는데 거의 동시에 DB 저장을 요청할 경우 둘 중 하나는 수행되지 않는다.
2. 둘 중 하나가 실패하더라도 나머지 하나에 대한 결과는 반환 되어져야한다.

그렇기 때문에 동시에 들어온 요청을 순차적으로 처리할 필요성이 있습니다.











